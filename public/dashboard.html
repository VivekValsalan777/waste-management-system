<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
</head>
<body>

<h2>Admin Dashboard</h2>

<button onclick="loadReports()">Load Reports</button>
<button onclick="clearCompleted()">Clear Completed Reports</button>
<button onclick="logout()">Logout</button>

<hr>

<h3>Active Reports</h3>
<table border="1" cellpadding="6">
  <thead>
    <tr>
      <th>Image</th>
      <th>Report ID</th>
      <th>Status</th>
      <th>Update Status</th>
      <th>Location</th>
      <th>Date</th>
    </tr>
  </thead>
  <tbody id="activeTable"></tbody>
</table>

<hr>

<h3>Completed Reports</h3>
<table border="1" cellpadding="6">
  <thead>
    <tr>
      <th>Image</th>
      <th>Report ID</th>
      <th>Location</th>
      <th>Date</th>
    </tr>
  </thead>
  <tbody id="completedTable"></tbody>
</table>

<script>
/* ================= AUTH CHECK ================= */
fetch("/admin/reports").then(res => {
  if (res.status === 401) {
    alert("Unauthorized access. Please login.");
    location.href = "admin-login.html";
  }
});

/* ================= LOAD REPORTS ================= */
function loadReports() {
  fetch("/admin/reports")
    .then(res => res.json())
    .then(data => {
      activeTable.innerHTML = "";
      completedTable.innerHTML = "";

      if (data.length === 0) {
        activeTable.innerHTML =
          "<tr><td colspan='6'>No active reports</td></tr>";
        completedTable.innerHTML =
          "<tr><td colspan='4'>No completed reports</td></tr>";
        return;
      }

      data.forEach(report => {
        const mapLink =
          `https://www.google.com/maps?q=${report.location.latitude},${report.location.longitude}`;

        if (report.status === "Completed") {
          completedTable.innerHTML += `
            <tr>
              <td>
                <img src="/uploads/${report.image}" width="80">
              </td>
              <td>${report.reportId}</td>
              <td>
                <a href="${mapLink}" target="_blank">View Map</a>
              </td>
              <td>${new Date(report.createdAt).toLocaleString()}</td>
            </tr>
          `;
        } else {
          activeTable.innerHTML += `
            <tr>
              <td>
                <img src="/uploads/${report.image}" width="80">
              </td>
              <td>${report.reportId}</td>
              <td>${report.status}</td>
              <td>
                <select id="status-${report.reportId}">
                  <option ${report.status === "Pending" ? "selected" : ""}>
                    Pending
                  </option>
                  <option ${report.status === "In Progress" ? "selected" : ""}>
                    In Progress
                  </option>
                  <option ${report.status === "Completed" ? "selected" : ""}>
                    Completed
                  </option>
                </select>
                <button onclick="updateStatus('${report.reportId}')">
                  Save
                </button>
              </td>
              <td>
                <a href="${mapLink}" target="_blank">View Map</a>
              </td>
              <td>${new Date(report.createdAt).toLocaleString()}</td>
            </tr>
          `;
        }
      });
    });
}

/* ================= UPDATE STATUS ================= */
function updateStatus(reportId) {
  const status =
    document.getElementById("status-" + reportId).value;

  fetch("/admin/update-status", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ reportId, status })
  })
    .then(() => {
      alert("Status updated successfully");
      loadReports();
    });
}

/* ================= CLEAR COMPLETED ================= */
function clearCompleted() {
  if (!confirm("Are you sure you want to delete all completed reports?"))
    return;

  fetch("/admin/clear-completed", { method: "POST" })
    .then(() => {
      alert("Completed reports cleared");
      loadReports();
    });
}

/* ================= LOGOUT ================= */
function logout() {
  fetch("/admin/logout", { method: "POST" })
    .then(() => {
      location.href = "admin-login.html";
    });
}
</script>

</body>
</html>
